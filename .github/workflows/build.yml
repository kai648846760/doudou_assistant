name: æ„å»ºä¸å‘å¸ƒ

# æ³¨æ„ï¼šå‘å¸ƒéœ€è¦åœ¨ä»“åº“è®¾ç½®ä¸­å°† Actions â†’ Workflow permissions è°ƒæ•´ä¸º "Read and write"ï¼Œä»¥ä¾¿å·¥ä½œæµå¯ä»¥ä¸Šä¼  Release äº§ç‰©ã€‚
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  check_paths:
    # é¢„æ£€æŸ¥ï¼šç¡®ä¿ä»“åº“ä¸­æ²¡æœ‰ Windows éæ³•è·¯å¾„
    name: æ£€æŸ¥ Windows è·¯å¾„åˆæ³•æ€§
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è¿è¡Œ Windows è·¯å¾„æ£€æŸ¥
        run: |
          chmod +x ./scripts/check_windows_paths.sh
          ./scripts/check_windows_paths.sh

  build_macos:
    # macOS æ„å»ºä»»åŠ¡ï¼ˆç‹¬ç«‹ï¼‰
    name: æ„å»º macOS
    runs-on: macos-latest
    needs: check_paths
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3

      - name: åŒæ­¥ä¾èµ–
        run: uv sync

      - name: å®‰è£… PyInstaller
        run: uv pip install pyinstaller

      - name: æ„å»º macOS åº”ç”¨
        shell: bash
        run: |
          chmod +x ./scripts/build_mac.sh
          ./scripts/build_mac.sh

      - name: ç”Ÿæˆ macOS SHA256 æ ¡éªŒæ–‡ä»¶
        shell: bash
        run: |
          cd dist
          shasum -a 256 DouDouAssistant-macOS.zip > DouDouAssistant-macOS.zip.sha256

      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: DouDouAssistant-macOS
          path: |
            dist/DouDouAssistant-macOS.zip
            dist/DouDouAssistant-macOS.zip.sha256

  build_windows:
    # Windows æ„å»ºä»»åŠ¡ï¼ˆç‹¬ç«‹ï¼Œä¾èµ–è·¯å¾„æ£€æŸ¥ï¼‰
    name: æ„å»º Windows
    runs-on: windows-latest
    needs: check_paths
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3

      - name: åŒæ­¥ä¾èµ–
        run: uv sync

      - name: å®‰è£… PyInstaller
        run: uv pip install pyinstaller

      - name: æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶
        shell: pwsh
        run: |
          .\scripts\build_win.ps1

      - name: ç”Ÿæˆ Windows SHA256 æ ¡éªŒæ–‡ä»¶
        shell: pwsh
        run: |
          $hash = Get-FileHash -Path dist\DouDouAssistant.exe -Algorithm SHA256
          "$($hash.Hash)  DouDouAssistant.exe" | Out-File -FilePath dist\DouDouAssistant.exe.sha256 -Encoding ASCII

      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: DouDouAssistant-Windows
          path: |
            dist/DouDouAssistant.exe
            dist/DouDouAssistant.exe.sha256

  release:
    # ä»…åœ¨ Tag è§¦å‘æ—¶æ‰§è¡Œï¼Œå°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° GitHub Release
    # ä¸´æ—¶ç­–ç•¥ï¼šä»…ä¾èµ– macOS æ„å»ºæˆåŠŸå³å¯å‘å¸ƒï¼ˆWindows ä¿®å¤ä¸­ï¼‰
    name: å‘å¸ƒ Release
    needs: build_macos
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ä¸‹è½½ macOS æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: DouDouAssistant-macOS
          path: artifacts/DouDouAssistant-macOS

      - name: å°è¯•ä¸‹è½½ Windows æ„å»ºäº§ç‰©ï¼ˆå¯é€‰ï¼‰
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: DouDouAssistant-Windows
          path: artifacts/DouDouAssistant-Windows

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/DouDouAssistant-macOS/DouDouAssistant-macOS.zip
            artifacts/DouDouAssistant-macOS/DouDouAssistant-macOS.zip.sha256
            artifacts/DouDouAssistant-Windows/DouDouAssistant.exe
            artifacts/DouDouAssistant-Windows/DouDouAssistant.exe.sha256
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸš€ å‘å¸ƒè¯´æ˜
            
            **å½“å‰çŠ¶æ€**: æ­¤ç‰ˆæœ¬åŒ…å« macOS æ„å»ºäº§ç‰©ã€‚Windows æ„å»ºæ­£åœ¨ä¿®å¤ä¸­ã€‚
            
            ### macOS ç”¨æˆ·
            - ä¸‹è½½ `DouDouAssistant-macOS.zip`
            - è§£å‹åè¿è¡Œ `DouDouAssistant.app`
            
            ### Windows ç”¨æˆ·
            - Windows ç‰ˆæœ¬æ­£åœ¨ä¿®å¤ä¸­ï¼Œæ•¬è¯·æœŸå¾…ä¸‹ä¸€ä¸ªç‰ˆæœ¬
            
            â„¹ï¸ æ‰€æœ‰äº§ç‰©å‡é™„å¸¦ SHA256 æ ¡éªŒæ–‡ä»¶
          fail_on_unmatched_files: false
